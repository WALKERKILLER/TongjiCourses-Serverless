name: Sync Onesystem (Login) To D1

on:
  workflow_dispatch:
    inputs:
      calendarId:
        description: "一系统学期ID (例如 121)"
        required: true
        type: string
      depth:
        description: "同步深度 (从 calendarId 往前同步多少学期，默认 1)"
        required: false
        default: "1"
        type: string
  # dev 分支允许通过 push 触发（提交信息包含 [pk-sync] 且带 calendarId/depth）
  push:
    branches: ["dev"]

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, '[pk-sync]'))

    env:
      PYTHONIOENCODING: utf-8
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      # dev 分支优先使用 BACKEND_URL_DEV 用于同步后自检；不再依赖后端接口完成同步
      BACKEND_URL: ${{ (github.ref_name == 'dev' && secrets.BACKEND_URL_DEV) || secrets.BACKEND_URL || secrets.VITE_API_URL }}
      ONESYSTEM_SNO: ${{ secrets.ONESYSTEM_SNO }}
      ONESYSTEM_PASSWORD: ${{ secrets.ONESYSTEM_PASSWORD }}
      ONESYSTEM_IMAP_SERVER: ${{ secrets.ONESYSTEM_IMAP_SERVER }}
      ONESYSTEM_IMAP_PORT: ${{ secrets.ONESYSTEM_IMAP_PORT }}
      ONESYSTEM_IMAP_EMAIL: ${{ secrets.ONESYSTEM_IMAP_EMAIL }}
      ONESYSTEM_IMAP_GRANTCODE: ${{ secrets.ONESYSTEM_IMAP_GRANTCODE }}

    steps:
      - name: Resolve calendarId/depth
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "calendarId=${{ inputs.calendarId }}" >> "$GITHUB_OUTPUT"
            echo "depth=${{ inputs.depth }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          msg="${{ github.event.head_commit.message }}"
          calendarId="$(echo "$msg" | sed -nE 's/.*calendarId=([0-9]+).*/\1/p' | head -n1)"
          depth="$(echo "$msg" | sed -nE 's/.*depth=([0-9]+).*/\1/p' | head -n1)"

          if [ -z "$calendarId" ]; then
            echo "Missing calendarId in commit message. Example: [pk-sync] calendarId=121 depth=3" >&2
            exit 1
          fi
          if [ -z "$depth" ]; then depth="1"; fi

          echo "calendarId=$calendarId" >> "$GITHUB_OUTPUT"
          echo "depth=$depth" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate secrets
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${CLOUDFLARE_API_TOKEN:-}" ]; then echo "Missing secrets.CLOUDFLARE_API_TOKEN" >&2; exit 1; fi
          if [ -z "${CLOUDFLARE_ACCOUNT_ID:-}" ]; then echo "Missing secrets.CLOUDFLARE_ACCOUNT_ID" >&2; exit 1; fi
          if [ -z "${ONESYSTEM_SNO:-}" ]; then echo "Missing secrets.ONESYSTEM_SNO" >&2; exit 1; fi
          if [ -z "${ONESYSTEM_PASSWORD:-}" ]; then echo "Missing secrets.ONESYSTEM_PASSWORD" >&2; exit 1; fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install backend deps (wrangler)
        working-directory: backend
        run: npm install

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests pycryptodome beautifulsoup4

      - name: Write onesystem config (runtime)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p backend
          printf "%s\n" "[Account]" > backend/config.onesystem.ini
          printf "sno=%s\n" "$ONESYSTEM_SNO" >> backend/config.onesystem.ini
          printf "passwd=%s\n" "$ONESYSTEM_PASSWORD" >> backend/config.onesystem.ini
          # Optional IMAP section (only needed if your account triggers extra verification / email code)
          if [ -n "${ONESYSTEM_IMAP_SERVER:-}" ] && [ -n "${ONESYSTEM_IMAP_PORT:-}" ] && [ -n "${ONESYSTEM_IMAP_EMAIL:-}" ] && [ -n "${ONESYSTEM_IMAP_GRANTCODE:-}" ]; then
            printf "\n%s\n" "[IMAP]" >> backend/config.onesystem.ini
            printf "server_domain=%s\n" "$ONESYSTEM_IMAP_SERVER" >> backend/config.onesystem.ini
            printf "server_port=%s\n" "$ONESYSTEM_IMAP_PORT" >> backend/config.onesystem.ini
            printf "qq_emailaddr=%s\n" "$ONESYSTEM_IMAP_EMAIL" >> backend/config.onesystem.ini
            printf "qq_grantcode=%s\n" "$ONESYSTEM_IMAP_GRANTCODE" >> backend/config.onesystem.ini
          fi

      - name: Ensure pk tables on D1 (remote)
        working-directory: backend
        run: npx wrangler d1 execute jcourse-db --remote --file="./migrations/001_pk_schema.sql"

      - name: Login & export SQL
        id: export
        working-directory: backend
        shell: bash
        continue-on-error: true
        run: |
          set -euo pipefail
          python -u ./scripts/pk-login-and-export-sql.py \
            --calendarId "${{ steps.resolve.outputs.calendarId }}" \
            --depth "${{ steps.resolve.outputs.depth }}" \
            --out-dir ".tmp/pk-sync" \
            --config "./config.onesystem.ini" \
            2>&1 | tee pk-sync-summary.log

      - name: Debug export failure (commit comment)
        if: steps.export.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = require("path");
            const logPath = path.join(process.env.GITHUB_WORKSPACE, "backend", "pk-sync-summary.log");
            let body = "";
            try {
              const content = fs.readFileSync(logPath, "utf8");
              const lines = content.split(/\r?\n/);
              const tail = lines.slice(-200).join("\n");
              body =
                "pk-sync: Login & export SQL failed. Last 200 lines:\n\n" +
                "```text\n" +
                tail +
                "\n```";
            } catch (e) {
              body = "pk-sync: Login & export SQL failed, but failed to read pk-sync-summary.log: " + String(e);
            }

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body,
            });

      - name: Fail if export failed
        if: steps.export.outcome == 'failure'
        shell: bash
        run: |
          echo "Login & export SQL failed (see commit comment for tail logs)." >&2
          exit 1

      - name: Apply SQL to D1 (remote)
        working-directory: backend
        shell: bash
        run: |
          set -euo pipefail
          ls -la .tmp/pk-sync
          for f in .tmp/pk-sync/pk-sync-*.sql; do
            echo "Applying $f"
            npx wrangler d1 execute jcourse-db --remote --file="$f"
          done

      - name: Post-check via backend API
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${BACKEND_URL:-}" ]; then
            echo "BACKEND_URL not set, skip api check"
            exit 0
          fi
          BACKEND_URL="${BACKEND_URL%/}"
          if [[ "$BACKEND_URL" == */api ]]; then BACKEND_URL="${BACKEND_URL%/api}"; fi
          echo "Check: $BACKEND_URL/api/getAllCalendar"
          curl -fsSL "$BACKEND_URL/api/getAllCalendar" | head -c 500
          echo
