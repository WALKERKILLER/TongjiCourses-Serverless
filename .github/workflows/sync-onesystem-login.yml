name: Sync Onesystem (Login) To D1

on:
  workflow_dispatch:
    inputs:
      calendarId:
        description: "一系统学期ID (例如 121)"
        required: true
        type: string
      depth:
        description: "同步深度 (从 calendarId 往前同步多少学期，默认 1)"
        required: false
        default: "1"
        type: string
  # 便于在 dev 分支上“测试到可用”为止：通过 push 触发（需要提交信息包含 [pk-sync]）
  push:
    branches: ["dev"]

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, '[pk-sync]'))
    env:
      PYTHONIOENCODING: utf-8
      # Prefer BACKEND_URL (explicit backend base), fallback to VITE_API_URL (frontend uses it as API base)
      BACKEND_URL: ${{ secrets.BACKEND_URL || secrets.VITE_API_URL }}
      ADMIN_SECRET: ${{ secrets.JCOURSE_ADMIN_SECRET }}
      ONESYSTEM_SNO: ${{ secrets.ONESYSTEM_SNO }}
      ONESYSTEM_PASSWORD: ${{ secrets.ONESYSTEM_PASSWORD }}
      ONESYSTEM_IMAP_SERVER: ${{ secrets.ONESYSTEM_IMAP_SERVER }}
      ONESYSTEM_IMAP_PORT: ${{ secrets.ONESYSTEM_IMAP_PORT }}
      ONESYSTEM_IMAP_EMAIL: ${{ secrets.ONESYSTEM_IMAP_EMAIL }}
      ONESYSTEM_IMAP_GRANTCODE: ${{ secrets.ONESYSTEM_IMAP_GRANTCODE }}
    steps:
      - name: Resolve calendarId/depth
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "calendarId=${{ inputs.calendarId }}" >> "$GITHUB_OUTPUT"
            echo "depth=${{ inputs.depth }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          msg="${{ github.event.head_commit.message }}"
          calendarId="$(echo "$msg" | sed -nE 's/.*calendarId=([0-9]+).*/\1/p' | head -n1)"
          depth="$(echo "$msg" | sed -nE 's/.*depth=([0-9]+).*/\1/p' | head -n1)"

          if [ -z "$calendarId" ]; then
            echo "Missing calendarId in commit message. Example: [pk-sync] calendarId=121 depth=1" >&2
            exit 1
          fi

          if [ -z "$depth" ]; then depth="1"; fi
          echo "calendarId=$calendarId" >> "$GITHUB_OUTPUT"
          echo "depth=$depth" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "$BACKEND_URL" ]; then echo "Missing secrets.BACKEND_URL (or secrets.VITE_API_URL) (backend base url)" >&2; exit 1; fi
          if [ -z "$ADMIN_SECRET" ]; then echo "Missing secrets.JCOURSE_ADMIN_SECRET (x-admin-secret)" >&2; exit 1; fi
          if [ -z "$ONESYSTEM_SNO" ]; then echo "Missing secrets.ONESYSTEM_SNO" >&2; exit 1; fi
          if [ -z "$ONESYSTEM_PASSWORD" ]; then echo "Missing secrets.ONESYSTEM_PASSWORD" >&2; exit 1; fi

      - name: Normalize & preflight backend url
        shell: bash
        run: |
          set -euo pipefail
          # If user mistakenly sets BACKEND_URL ending with /api, normalize it to base origin.
          BACKEND_URL="${BACKEND_URL%/}"
          if [[ "$BACKEND_URL" == */api ]]; then BACKEND_URL="${BACKEND_URL%/api}"; fi
          echo "BACKEND_URL=$BACKEND_URL" >> "$GITHUB_ENV"

          code="$(curl -sS -o /dev/null -w '%{http_code}' -X OPTIONS "$BACKEND_URL/api/admin/pk/sync" || true)"
          if [ "$code" = "404" ]; then
            echo "Backend endpoint not found: $BACKEND_URL/api/admin/pk/sync" >&2
            echo "This usually means the backend Worker at BACKEND_URL is not deployed with pk sync route yet (or BACKEND_URL points to frontend Pages)." >&2
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests pycryptodome beautifulsoup4

      - name: Write onesystem config (runtime)
        run: |
          set -euo pipefail
          mkdir -p backend
          printf "%s\n" "[Account]" > backend/config.onesystem.ini
          printf "sno=%s\n" "$ONESYSTEM_SNO" >> backend/config.onesystem.ini
          printf "passwd=%s\n" "$ONESYSTEM_PASSWORD" >> backend/config.onesystem.ini
          # Optional IMAP section (only needed if your account triggers extra verification / email code)
          if [ -n "${ONESYSTEM_IMAP_SERVER:-}" ] && [ -n "${ONESYSTEM_IMAP_PORT:-}" ] && [ -n "${ONESYSTEM_IMAP_EMAIL:-}" ] && [ -n "${ONESYSTEM_IMAP_GRANTCODE:-}" ]; then
            printf "\n%s\n" "[IMAP]" >> backend/config.onesystem.ini
            printf "server_domain=%s\n" "$ONESYSTEM_IMAP_SERVER" >> backend/config.onesystem.ini
            printf "server_port=%s\n" "$ONESYSTEM_IMAP_PORT" >> backend/config.onesystem.ini
            printf "qq_emailaddr=%s\n" "$ONESYSTEM_IMAP_EMAIL" >> backend/config.onesystem.ini
            printf "qq_grantcode=%s\n" "$ONESYSTEM_IMAP_GRANTCODE" >> backend/config.onesystem.ini
          fi

      - name: Login & sync
        run: |
          set -euo pipefail
          cd backend
          python ./scripts/pk-login-and-sync.py --calendarId "${{ steps.resolve.outputs.calendarId }}" --depth "${{ steps.resolve.outputs.depth }}" --base-url "$BACKEND_URL" --config "./config.onesystem.ini"
